%script{src:'http://maps.google.com/maps/api/js?sensor=false&libraries=visualization,geometry,places'}
%script{src:"http://js.pusher.com/1.12/pusher.min.js"}

#map_canvas

:coffeescript
  google.maps.visualRefresh = true
  gateway = new Pusher("f513119581ede36ac6c4").subscribe "gateway"
  carNames = #{@car_names.to_json}
  latestReadings = #{@latest_readings.to_json}


  addMarker = (reading) ->
    for k,v of reading
      longitude = v[0]
      latitude = v[1]
      mobileId = k
      carName = carNames[String(k)]

    $('#map_canvas').gmap 'addMarker',
      animation : google.maps.Animation.DROP
      bounds    : true
      mobileId  : [mobileId]
      position  : (new google.maps.LatLng(latitude, longitude))
      icon      : 'http://chart.googleapis.com/chart?chst=d_simple_text_icon_above&chld=' + carName + '|16|bf6410|car-dealer|16|bf6410|FFF'

  gateway.bind 'message', (reading) ->
    $('#map_canvas').gmap 'find', 'markers', { 'property':'mobileId', 'value':reading.mobileId }, (marker, found) ->
      if found
        marker.setPosition (new google.maps.LatLng(reading.geo.latitude, reading.geo.longitude))
      else
        addMarker(null, reading)

      $('#map_canvas').gmap('get', 'map').panTo createPoint(reading)

  $('#map_canvas').gmap().bind 'init', ->

    latestReadings.forEach addMarker