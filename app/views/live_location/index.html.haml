%script{src:'http://maps.google.com/maps/api/js?sensor=false&libraries=visualization,geometry,places'}
%script{src:"http://js.pusher.com/1.12/pusher.min.js"}

#map_canvas

:coffeescript
  google.maps.visualRefresh = true
  gateway = new Pusher("f513119581ede36ac6c4").subscribe "gateway"
  carNames = #{@car_names.to_json}

  createPoint = (reading) ->
    [longitude, latitude] = reading.geo.coordinates
    new google.maps.LatLng(latitude, longitude)

  addMarker = (i, reading) ->
    carName = carNames[reading.mobileId]

    $('#map_canvas').gmap 'addMarker',
      animation : google.maps.Animation.DROP
      bounds    : true
      mobileId  : [reading.mobileId]
      position  : createPoint(reading)
      icon      : 'http://chart.googleapis.com/chart?chst=d_simple_text_icon_above&chld=' + carName + '|16|bf6410|car-dealer|16|bf6410|FFF'

  gateway.bind 'message', (reading) ->
    $('#map_canvas').gmap 'find', 'markers', { 'property':'mobileId', 'value':reading.mobileId }, (marker, found) ->
      if found
        marker.setPosition createPoint(reading)
      else
        addMarker(null, reading)

      $('#map_canvas').gmap('get', 'map').panTo createPoint(reading)

  $('#map_canvas').gmap().bind 'init', ->

    $.getJSON "https://api.mongohq.com/databases/gateway/collections/readings/documents?_apikey=3ivyp1chsvvas6kz8gsz&limit=1&q={mobileId:'4531004944'}&sort={_id:-1}", (data) ->
      $.each data, addMarker