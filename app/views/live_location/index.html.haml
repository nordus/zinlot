%script{src:'http://maps.google.com/maps/api/js?sensor=false&libraries=visualization,geometry,places'}

#map_canvas

%script{src:"http://js.pusher.com/1.12/pusher.min.js"}
:coffeescript
  pusher = new Pusher "f513119581ede36ac6c4"
  debug = pusher.subscribe "gateway"

  window.mapIcon = undefined

  google.maps.visualRefresh = true

  $('#map_canvas').gmap().bind 'init', ->

    $.getJSON "https://api.mongohq.com/databases/gateway/collections/readings/documents?_apikey=3ivyp1chsvvas6kz8gsz&limit=1&q={mobileId:'4531004944'}&sort={_id:-1}", (data) ->
      $.each data, (i, marker) ->
        [longitude, latitude] = marker.geo.coordinates
        point = new google.maps.LatLng(latitude, longitude)
        markerAttrs =
          animation : google.maps.Animation.DROP
          bounds    : true
          position  : point
          icon      : 'http://chart.googleapis.com/chart?chst=d_simple_text_icon_above&chld=Terjes%20Acadia|16|bf6410|car-dealer|16|bf6410|FFF'

        window.mapIcon = $('#map_canvas').gmap 'addMarker', markerAttrs

    debug.bind "message", (marker) ->
      [longitude, latitude] = marker.geo.coordinates
      point = new google.maps.LatLng(latitude, longitude)
      window.mapIcon.setPosition(point)